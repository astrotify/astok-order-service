name: Run Database Migration

on:
  workflow_dispatch:
    inputs:
      direction:
        description: "Migration direction"
        required: true
        default: "up"
        type: choice
        options:
          - up
          - down
      steps:
        description: "Number of migration steps (leave empty for all)"
        required: false
        default: ""
        type: string

env:
  AWS_REGION: ap-southeast-1
  ECS_CLUSTER: astok-cluster
  ECS_SERVICE: astok-order-service

jobs:
  migrate:
    name: Run Migration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build migration image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Create migration Dockerfile
          cat > Dockerfile.migrate << 'EOF'
          FROM migrate/migrate:latest
          COPY internal/database/migrations /migrations
          ENTRYPOINT ["migrate", "-path", "/migrations", "-database"]
          EOF

          # Build and push
          docker build --platform linux/amd64 -f Dockerfile.migrate -t $ECR_REGISTRY/astok-order-migrate:latest .
          docker push $ECR_REGISTRY/astok-order-migrate:latest

          echo "‚úÖ Migration image pushed"

      - name: Get network configuration
        id: network
        run: |
          SERVICE_CONFIG=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].networkConfiguration.awsvpcConfiguration')

          SUBNETS=$(echo $SERVICE_CONFIG | jq -r '.subnets | join(",")')
          SECURITY_GROUPS=$(echo $SERVICE_CONFIG | jq -r '.securityGroups | join(",")')

          echo "subnets=$SUBNETS" >> $GITHUB_OUTPUT
          echo "security_groups=$SECURITY_GROUPS" >> $GITHUB_OUTPUT

      - name: Create migration task definition
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          DIRECTION="${{ github.event.inputs.direction }}"
          STEPS="${{ github.event.inputs.steps }}"

          # Build migration command
          if [ -n "$STEPS" ]; then
            MIGRATE_CMD="$DIRECTION $STEPS"
          else
            MIGRATE_CMD="$DIRECTION"
          fi

          DB_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/${DB_NAME}?sslmode=require"

          cat > migrate-task.json << EOF
          {
            "family": "astok-db-migrate",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "256",
            "memory": "512",
            "executionRoleArn": "arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ecsTaskExecutionRole",
            "containerDefinitions": [
              {
                "name": "migrate",
                "image": "$ECR_REGISTRY/astok-order-migrate:latest",
                "essential": true,
                "command": ["$DB_URL", "-verbose", "$MIGRATE_CMD"],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/astok-migrations",
                    "awslogs-create-group": "true",
                    "awslogs-region": "${{ env.AWS_REGION }}",
                    "awslogs-stream-prefix": "migrate"
                  }
                }
              }
            ]
          }
          EOF

          # Register task definition
          aws ecs register-task-definition --cli-input-json file://migrate-task.json

          echo "‚úÖ Migration task definition registered"

      - name: Run migration task
        id: run-migration
        run: |
          echo "üîÑ Running migration (${{ github.event.inputs.direction }})..."

          TASK_ARN=$(aws ecs run-task \
            --cluster $ECS_CLUSTER \
            --task-definition astok-db-migrate \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.network.outputs.subnets }}],securityGroups=[${{ steps.network.outputs.security_groups }}],assignPublicIp=DISABLED}" \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Task ARN: $TASK_ARN"
          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT

          # Wait for task to complete
          echo "‚è≥ Waiting for migration to complete..."
          aws ecs wait tasks-stopped --cluster $ECS_CLUSTER --tasks $TASK_ARN

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster $ECS_CLUSTER \
            --tasks $TASK_ARN \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          echo "Exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" = "0" ]; then
            echo "‚úÖ Migration completed successfully!"
          else
            echo "‚ùå Migration failed with exit code: $EXIT_CODE"
            exit 1
          fi

      - name: Show migration logs
        if: always()
        run: |
          echo "üìã Migration logs:"
          aws logs tail /ecs/astok-migrations --since 10m || echo "No logs found"
